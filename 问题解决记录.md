# AI生成导览手绘图 - 问题解决记录

## 问题描述
项目在执行后，网页选中区域，后端执行时：
- `semantic_map.png` ✅ 生成成功
- `control_canny.png` ✅ 生成成功  
- `final_map.png` ❌ **生成纯黑色图像，没有效果**

## 问题分析过程

### 1. 初步尝试
- 尝试将 `sd-controlnet-canny`（Canny边缘模型）替换为 `sd-controlnet-scribble`（涂鸦/线稿模型）
- **结果**：仍然生成黑色图像

### 2. 深入调试
通过创建最简化测试脚本 `test_controlnet.py` 发现：
- **MPS模式测试**：生成过程正常完成，但输出图像为纯黑色
- **CPU模式测试**：生成彩色正常图像，像素值范围 0-255

### 3. 根本原因确定
**Apple Silicon MPS后端兼容性问题**：
- MPS设备在处理Stable Diffusion ControlNet时存在数值精度问题
- 生成过程中产生NaN或无穷大值
- 图像后处理时无效数值转换为uint8变成黑色像素
- 出现警告：`RuntimeWarning: invalid value encountered in cast`

## 解决方案

### 最终方案：强制使用CPU模式
创建 `main_cpu.py` - CPU专用版本：

#### 关键修改点：
1. **强制CPU设备**：
```python
device = "cpu"  # 强制CPU，避免MPS问题
torch_dtype=torch.float32  # CPU使用float32精度
```

2. **优化生成参数**：
```python
num_inference_steps=20,  # CPU模式适中步数
controlnet_conditioning_scale=0.8,  # 适中控制强度
guidance_scale=8.0  # 平衡的引导强度
```

3. **改进提示词**：
```python
prompt = "beautiful hand drawn map illustration, watercolor style, aerial view, colorful buildings and parks, roads and pathways, artistic map design"
negative_prompt = "blurry, dark, black, monochrome, low quality"
```

4. **完整前端界面**：
创建 `index.html` 提供直观的地图选择和生成功能

### 启动方式
```bash
uvicorn main_cpu:app --host 127.0.0.1 --port 8001 --reload
```

## 测试结果

### CPU测试成功验证：
- ✅ **简单测试**：`cpu_test_output.png` 生成彩色建筑图像
- ✅ **实际项目**：成功生成彩色手绘地图，20步推理完成
- ✅ **稳定性**：无数值异常，无黑色图像问题

### 性能对比：
- **MPS模式**：速度快但生成黑色图像（不可用）
- **CPU模式**：速度较慢（~10分钟）但结果稳定可靠

## 技术要点总结

### 问题根源：
1. **设备兼容性**：Apple Silicon MPS与Stable Diffusion ControlNet存在兼容性问题
2. **数值精度**：MPS后端在某些操作中产生无效数值
3. **图像转换**：无效数值在uint8转换时变成黑色

### 解决策略：
1. **设备切换**：从MPS切换到CPU确保数值稳定
2. **参数优化**：针对CPU调整推理参数
3. **完整测试**：通过简化测试验证解决方案有效性

## 文件结构

```
项目目录/
├── main.py              # 原始MPS版本（有黑色图像问题）
├── main_cpu.py          # CPU版本（问题已解决）✅
├── index.html           # 前端界面
├── test_controlnet.py   # MPS测试脚本
├── test_cpu_simple.py   # CPU测试脚本
├── debug_runs/          # 生成结果目录
│   └── [job_id]/
│       ├── semantic_map.png    # 语义地图
│       ├── control_canny.png   # Canny边缘
│       └── final_map.png       # 最终手绘地图✅
└── model_cache/         # 模型缓存目录
```

## 使用说明

1. **启动服务**：
```bash
uvicorn main_cpu:app --host 127.0.0.1 --port 8001 --reload
```

2. **访问界面**：http://127.0.0.1:8001

3. **操作步骤**：
   - 在地图上点击选择区域
   - 点击"生成手绘地图"按钮
   - 等待CPU模式生成完成（约10分钟）
   - 查看生成的彩色手绘地图

## 结论

通过将运行环境从MPS切换到CPU，成功解决了 `final_map.png` 生成黑色图像的问题。虽然CPU模式速度较慢，但能确保生成稳定的彩色手绘导览地图，满足项目需求。

**状态**：✅ **问题已完全解决**