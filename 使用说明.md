# AI手绘地图生成器 - 使用说明 (uv版本)

---

## 1. 项目简介

本项目是一个概念验证（PoC）应用，旨在通过AI技术，根据用户在地图上选择的地理范围，自动生成该区域的手绘风格地图。它集成了Web前端、Python后端、GIS数据查询和AI图像生成技术。

## 2. 环境设置 (使用uv)

本项目推荐使用 `uv` 进行环境和依赖管理，它提供了比 `pip` 和 `venv` 快得多的性能。

**第一步：安装uv**

如果您尚未安装uv，请通过pip或您操作系统的包管理器安装。最常见的方式是：

```bash
pip install uv
```

**第二步：创建并激活虚拟环境**

在项目根目录 (`AI生成导览手绘图`) 打开终端，运行以下命令创建虚拟环境：

```bash
# 创建虚拟环境
uv venv

# 激活虚拟环境 (macOS/Linux)
source .venv/bin/activate

# 激活虚拟环境 (Windows)
.venv\Scripts\activate
```

**第三步：安装依赖库**

激活虚拟环境后，使用uv高速安装所有必需的Python库：

```bash
uv pip install -r requirements.txt
```

**加速下载（可选，但强烈推荐）**

如果您的网络环境访问Python官方源较慢，可以指定一个国内镜像来极大提升下载速度。在安装时添加 `--index-url` 参数即可：

```bash
# 示例：使用清华大学镜像
uv pip install -r requirements.txt --index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

**警告：** 尽管uv安装速度很快，但此步骤仍需要从网上下载数GB的AI相关库（如PyTorch），请确保网络连接稳定。

## 3. 运行项目

**第一步：启动后端服务**
**第一步：启动后端服务**

确保您的虚拟环境已激活，然后选择合适的版本启动FastAPI后端服务：

**推荐：CPU版本（已解决黑色图像问题）**
```bash
uvicorn main_cpu:app --host 127.0.0.1 --port 8001 --reload
```
访问地址：http://127.0.0.1:8001

**原始版本（在Apple Silicon Mac上可能生成黑色图像）**
```bash
uvicorn main:app --reload
```
访问地址：http://127.0.0.1:8000

## ⚠️ 重要问题解决说明

**问题**：在Apple Silicon Mac上，原始版本可能生成纯黑色的 `final_map.png`

**原因**：MPS设备与Stable Diffusion ControlNet存在兼容性问题

**解决方案**：使用CPU版本 `main_cpu.py`，虽然速度较慢但结果稳定可靠

**状态**：✅ 问题已完全解决，CPU版本可正常生成彩色手绘地图

**新功能提示：** 服务器启动成功后，它会自动在您的默认浏览器中打开 `index.html` 页面。此功能仅在首次启动时触发，代码修改导致的热重载不会重复打开页面。

**警告：** 首次启动服务时，程序会自动从网上下载预训练的AI模型（Stable Diffusion和ControlNet），这同样需要数GB的下载量。您会看到终端长时间停留在加载模型的日志上，这是正常现象，请勿中断。

当您看到类似 `Application startup complete.` 的日志时，代表后端服务已准备就绪。

**第二步：打开前端页面**

如果浏览器没有自动打开，您可以手动在文件浏览器中找到 `index.html` 文件，并用任意现代浏览器（如Chrome, Firefox）打开它。

## 4. 如何使用

1.  **选择范围**：在浏览器打开的地图页面上，使用左侧的绘图工具（矩形或多边形）在地图上划定一个您感兴趣的区域。建议首次使用时选择一个**非常小**的区域（如单个街区），以便快速看到结果。
2.  **等待处理**：完成绘制后，前端会自动将坐标发送到后端进行处理。AI生成过程会消耗较多时间，在普通CPU上可能需要2-5分钟。请主要观察后端终端的日志输出，并留意前端页面的状态提示。
3.  **查看结果**：当后端任务完成后，生成的图片会自动叠加显示在地图上。您可以使用右上角的控件来控制图层的显隐和透明度。

---
*文档已更新，包含了镜像加速和自动打开浏览器的说明。*
