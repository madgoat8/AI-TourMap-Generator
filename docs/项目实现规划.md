### **项目实现规划：AI手绘地图生成器 (分阶段实施)**

---

### **整体工作流程图 (Mermaid)**

```mermaid
graph TD
    subgraph User
        A["用户在浏览器中打开项目页面"] --> B{"在地图上找到目标位置,划定范围"};
    end

    subgraph "Frontend (Browser - index.html)"
        B --> C["1. 发送坐标到 /api/start_generation"];
        C --> D["2. 立即获得唯一的 job_id"];
        D --> E{"3. 开始定时轮询 /api/job_status/{job_id}"};
        E -- 每3秒 --> F["4. 查询任务状态"];
        F -- status: processing --> E;
        F -- status: complete --> G["5. 成功获取Base64图片和地理边界"];
        G --> H["6. 创建 L.imageOverlay 图层"];
        H --> I["7. 将图层叠加到地图上"];
        I --> J{"8. 用户可通过控件调整图层显隐/透明度"};
    end

    subgraph "Backend (Server - main.py)"
        C --> K["接收请求, 创建job_id"];
        K --> L["立即返回 job_id"];
        K -- 触发 --> M["(后台异步任务开始)"];
  
        subgraph "Background Task (run_generation_task)"
            M --> N["a. 查询Overpass API获取GIS数据"];
            N --> O["b. 创建语义图 semantic_map.png"];
            O --> P["c. 提取边缘作为控制图 control_canny.png"];
            P --> P1["d. 加载风格参考图 demo1.png"];
            P1 --> Q["e. 加载SD+ControlNet+IP-Adapter模型"];
            Q --> R["f. 运行AI Pipeline生成手绘图<br>(输入: 结构图+风格图+提示词)"];
            R --> R1["g. 数据清洗(修复NaN值)"];
            R1 --> S["h. 将图片编码为Base64"];
            S --> T["i. 更新任务状态为'complete'并存储结果"];
        end

        F --> U["根据job_id查询任务状态"];
        U -- 返回JSON --> F;
    end

    L --> D;
```

---

### **第一阶段：基础底图生成 (当前目标)**

本阶段的核心目标是实现从用户划定地理范围到生成高质量、手绘风格的基础地图背景（底图）的完整流程。此阶段不包含具体的POI（兴趣点）信息。

#### **步骤1：前端用户界面 (已完成)**

* **功能**: 提供一个带有卫星和标准地图切换的界面，并允许用户使用绘图工具（多边形/矩形）划定一个地理范围。
* **现状**: 已在 `index.html` 中实现。

#### **步骤2：后端服务搭建 (已完成)**

* **技术**: Python + FastAPI。
* **目标**: 创建一个后端服务，能够接收前端发送过来的地理范围坐标。

#### **步骤3：GIS数据获取与处理 (已完成)**

* [X] **目标**: 根据接收到的范围，从OpenStreetMap (OSM) 获取生成底图所需的基础地理要素。
* [X] **查询内容**:
  * [X] **线状要素**: 道路 (`highway=*`), 路径 (`highway=path`), 水系 (`waterway=*`), 围墙/栅栏 (`barrier=*`)。
  * [X] **面状要素**: 水体 (`natural=water`), 绿地/森林 (`landuse=forest`, `leisure=park`), 建筑轮廓 (`building=yes`)。
* [X] **工具**: Overpass API。

#### **步骤4：核心AI生成 (已完成)**

* [X] **目标**: 将获取的GIS数据转换成AI能理解的“控制图”，并调用AI模型生成手绘风格图像。

**实现**:

1. [X] **创建语义分割图**: 将上一步获取的道路、水体、绿地等要素，用不同纯色绘制在一张空白画布上，形成AI生成时的“骨架”。
2. [X] **调用AI模型**: 使用Stable Diffusion + ControlNet，以语义分割图作为精确控制条件，结合描述风格的Prompt文本，生成手绘底图。
3. [X] **返回图像**: 将生成的图片返回给前端显示。

#### **待解决与现状**

* 🟡 **进行中**: 生成的手绘图,可以参考提供的参考手绘地图风格,这样确保风格一致。 (已引入IP-Adapter技术，正在测试和优化 `demo1.png` 的固定风格参考效果。)
* ⚠️ **现状**: 生成的手绘地图后续需要切成瓦片,这样就要求有高分辨率。为确保在MPS设备上稳定运行，当前生成分辨率已**降低至512x512**。高分辨率生成仍是未来挑战。

---

### **第二阶段：POI信息集成 (后续规划)**

本阶段将在已有的底图生成能力之上，增加POI的自动提取、人工管理和最终叠加功能。

* **目标**: 实现POI的完整处理流程。自动增加部分poi信息后,界面允许手动增加poi,并且增加poi的相关照片/图片作为后续生成该点位的素材.
* **规划中的功能**:
  1. **POI自动提取**: 从OSM、商业地图API等数据源自动抓取POI信息。
  2. **数据融合**: 将多来源的POI数据进行整合与去重。
  3. **POI手动管理**: 在前端提供界面，允许用户在地图上对POI点进行拖拽修改、编辑、删除和新增。
  4. **最终叠加**: 在AI生成好的手绘底图上，根据用户最终确认的POI位置和信息，绘制图标和文字。

todo:

- [X] 界面透明调整的组件无法拖动,可以点击.

- [~] **进行中**: 实现IP-Adapter风格参考功能，当前使用固定图片测试。

- [ ] **新**: 前端支持上传自定义风格参考图。
- [ ] 图片大小需要调整,选中范围后,需要截取最大缩放级别的对应范围的地图截图.
- [ ] 上一步的图片,范围太大,如何让sd处理
