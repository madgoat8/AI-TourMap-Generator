# AI-TourMap-Generator 模型下载指南

> 本文档详细介绍如何快速、稳定地下载项目所需的AI模型，特别针对国内网络环境进行了优化。

## 📋 目录

- [快速开始](#快速开始)
- [镜像源配置](#镜像源配置)
- [下载工具使用](#下载工具使用)
- [故障排除](#故障排除)
- [离线部署](#离线部署)
- [高级配置](#高级配置)

## 🚀 快速开始

### 方法一：一键下载（推荐）

```bash
# Windows 用户
download_models.bat

# Linux/Mac 用户
python download_models.py
```

### 方法二：手动配置

```bash
# 1. 配置国内镜像
python setup_mirror.py hf-mirror

# 2. 下载模型
python download_models.py

# 3. 验证下载
python setup_mirror.py test
```

## 🌐 镜像源配置

### 可用镜像源

| 镜像名称 | 地址 | 特点 | 推荐指数 |
|---------|------|------|---------|
| **hf-mirror** | https://hf-mirror.com | 🔥 国内优化，速度最快 | ⭐⭐⭐⭐⭐ |
| **modelscope** | https://www.modelscope.cn | 阿里云镜像，稳定性好 | ⭐⭐⭐⭐ |
| **official** | https://huggingface.co | 官方源，最新最全 | ⭐⭐⭐ |

### 镜像配置方法

#### 自动选择最佳镜像
```bash
python setup_mirror.py auto
```

#### 手动指定镜像
```bash
# 使用 hf-mirror（推荐）
python setup_mirror.py hf-mirror

# 使用 modelscope
python setup_mirror.py modelscope

# 使用官方源
python setup_mirror.py official
```

#### 测试镜像连通性
```bash
python setup_mirror.py test
```

## 🛠️ 下载工具使用

### 核心脚本说明

#### `download_models.py` - 主下载脚本
- **功能**: 下载项目所需的所有AI模型
- **特性**: 
  - ✅ 断点续传支持
  - ✅ 自动重试机制
  - ✅ 进度显示
  - ✅ 错误容错

#### `setup_mirror.py` - 镜像配置工具
- **功能**: 配置和测试镜像源
- **特性**:
  - ✅ 多镜像源支持
  - ✅ 自动连通性测试
  - ✅ 智能镜像选择

#### `download_models.bat` - Windows一键脚本
- **功能**: Windows环境一键下载
- **特性**:
  - ✅ 自动环境检测
  - ✅ 虚拟环境激活
  - ✅ 网络状态检查

### 所需模型列表

| 模型名称 | 用途 | 大小 | 下载地址 |
|---------|------|------|---------|
| **ControlNet Canny** | 边缘检测控制 | ~1.2GB | lllyasviel/sd-controlnet-canny |
| **Stable Diffusion v1.5** | 图像生成基础模型 | ~4.2GB | runwayml/stable-diffusion-v1-5 |
| **IP-Adapter** | 风格迁移 | ~1.8GB | h94/IP-Adapter |
| **CLIP Encoder** | 图像编码器 | ~1.7GB | laion/CLIP-ViT-H-14-laion2B-s32B-b79K |

**总下载大小**: 约 8.9GB

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 网络连接问题
```bash
# 症状：连接超时或下载失败
# 解决方案：
python setup_mirror.py auto  # 自动选择镜像
```

#### 2. 代理配置冲突
```bash
# 症状：代理解析错误
# 解决方案：清除代理设置
set http_proxy=
set https_proxy=
set all_proxy=
```

#### 3. 磁盘空间不足
```bash
# 症状：下载中断
# 解决方案：清理缓存或更换缓存目录
export HF_HOME=/path/to/large/disk/cache
```

#### 4. 权限问题
```bash
# 症状：无法写入缓存目录
# 解决方案：
chmod 755 ./model_cache
# 或者更换到有权限的目录
```

### 错误代码说明

| 错误类型 | 可能原因 | 解决方案 |
|---------|---------|---------|
| `ConnectionError` | 网络连接问题 | 切换镜像源 |
| `HTTPError 404` | 模型路径错误 | 检查模型名称 |
| `OSError` | 磁盘空间/权限 | 检查存储空间和权限 |
| `ImportError` | 依赖缺失 | `pip install -r requirements.txt` |

## 💾 离线部署

### 模型缓存位置
```
model_cache/
├── models--lllyasviel--sd-controlnet-canny/
├── models--runwayml--stable-diffusion-v1-5/
├── models--h94--IP-Adapter/
└── models--laion--CLIP-ViT-H-14-laion2B-s32B-b79K/
```

### 离线传输步骤
1. **打包模型缓存**
   ```bash
   tar -czf models.tar.gz model_cache/
   ```

2. **传输到目标机器**
   ```bash
   scp models.tar.gz user@target:/path/to/project/
   ```

3. **解压并启动**
   ```bash
   tar -xzf models.tar.gz
   python start_offline.bat
   ```

## ⚙️ 高级配置

### 环境变量配置

```bash
# 镜像源设置
export HF_ENDPOINT=https://hf-mirror.com

# 缓存目录设置
export HF_HOME=/custom/cache/path

# 离线模式
export HF_HUB_OFFLINE=1
export TRANSFORMERS_OFFLINE=1

# 下载超时设置
export HF_HUB_DOWNLOAD_TIMEOUT=300
```

### 批量下载配置

创建 `download_config.py`:
```python
# 自定义下载配置
DOWNLOAD_CONFIG = {
    "cache_dir": "./custom_cache",
    "resume_download": True,
    "force_download": False,
    "local_files_only": False,
    "use_auth_token": None,
    "revision": "main"
}
```

### 网络优化配置

```python
# 设置下载线程数
os.environ['HF_HUB_DOWNLOAD_WORKERS'] = '4'

# 设置重试次数
os.environ['HF_HUB_DOWNLOAD_RETRIES'] = '3'

# 设置缓冲区大小
os.environ['HF_HUB_DOWNLOAD_CHUNK_SIZE'] = '10485760'  # 10MB
```

## 📊 性能对比

### 下载速度对比

| 镜像源 | 平均速度 | 成功率 | 延迟 |
|--------|---------|---------|------|
| hf-mirror | 8-15 MB/s | 95%+ | 20-50ms |
| modelscope | 5-12 MB/s | 90%+ | 30-80ms |
| official | 0.1-2 MB/s | 60%+ | 200-500ms |

### 系统要求

- **最小存储空间**: 10GB
- **推荐存储空间**: 20GB
- **网络带宽**: 建议 10Mbps+
- **内存**: 下载时需要 2GB+ 可用内存

## 🔍 验证下载

### 完整性检查
```bash
# 检查模型文件
python -c "
import os
cache_dir = './model_cache'
if os.path.exists(cache_dir):
    size = sum(os.path.getsize(os.path.join(dirpath, filename))
               for dirpath, dirnames, filenames in os.walk(cache_dir)
               for filename in filenames)
    print(f'缓存大小: {size / (1024**3):.2f} GB')
else:
    print('缓存目录不存在')
"
```

### 功能测试
```bash
# 测试模型加载
python -c "
from diffusers import ControlNetModel
try:
    model = ControlNetModel.from_pretrained(
        'lllyasviel/sd-controlnet-canny',
        cache_dir='./model_cache',
        local_files_only=True
    )
    print('✅ 模型加载成功')
except Exception as e:
    print(f'❌ 模型加载失败: {e}')
"
```

## 📞 技术支持

### 获取帮助
- **问题反馈**: 创建 GitHub Issue
- **技术讨论**: 查看项目 Wiki
- **实时支持**: 项目交流群

### 有用的命令
```bash
# 查看镜像状态
python setup_mirror.py info

# 清理缓存
rm -rf model_cache/

# 重新下载
python download_models.py --force-download

# 查看下载日志
tail -f generation.log
```

---

**最后更新**: 2024年8月
**版本**: v1.0
**维护者**: AI-TourMap-Generator Team